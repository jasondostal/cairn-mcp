services:
  cairn:
    image: ghcr.io/jasondostal/cairn-mcp:latest
    container_name: cairn
    restart: unless-stopped
    environment:
      CAIRN_DB_HOST: cairn-db
      CAIRN_DB_PORT: "5432"
      CAIRN_DB_NAME: cairn
      CAIRN_DB_USER: cairn
      CAIRN_DB_PASS: cairn-dev-password
      CAIRN_LLM_BACKEND: "${CAIRN_LLM_BACKEND:-bedrock}"
      CAIRN_BEDROCK_MODEL: "${CAIRN_BEDROCK_MODEL:-us.meta.llama3-2-90b-instruct-v1:0}"
      CAIRN_OLLAMA_URL: "${CAIRN_OLLAMA_URL:-http://host.docker.internal:11434}"
      CAIRN_OLLAMA_MODEL: "${CAIRN_OLLAMA_MODEL:-qwen2.5-coder:7b}"
    # Uncomment to mount AWS credentials for Bedrock:
    # volumes:
    #   - ~/.aws/credentials:/root/.aws/credentials:ro
    depends_on:
      cairn-db:
        condition: service_healthy

  cairn-db:
    image: pgvector/pgvector:pg16
    container_name: cairn-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: cairn
      POSTGRES_USER: cairn
      POSTGRES_PASSWORD: cairn-dev-password
    volumes:
      - cairn-pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cairn"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  cairn-pgdata:
